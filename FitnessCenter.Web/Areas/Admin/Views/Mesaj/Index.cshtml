@using FitnessCenter.Web.Services.Interfaces
@model List<KonusmaOzetVm>
@{
    ViewData["Title"] = "Mesajlar";
    var egitmenler = ViewData["Egitmenler"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
}

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div>
                <h1>Mesajlar</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Home" asp-action="Index">Admin</a></li>
                        <li class="breadcrumb-item active">Mesajlar</li>
                    </ol>
                </nav>
            </div>
            <div class="page-header-actions">
                <!-- Yeni Sohbet Dropdown -->
                <div class="dropdown">
                    <button class="btn-fc btn-fc-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            <line x1="12" y1="8" x2="12" y2="14"/>
                            <line x1="9" y1="11" x2="15" y2="11"/>
                        </svg>
                        Yeni Sohbet
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto;">
                        <li><h6 class="dropdown-header">Eğitmen Seçin</h6></li>
                        @if (egitmenler.Any())
                        {
                            @foreach (var egitmen in egitmenler)
                            {
                                <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2" 
                                       asp-action="Chat" asp-route-userId="@egitmen.ApplicationUserId">
                                        <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center" 
                                             style="width: 32px; height: 32px; font-size: 12px;">
                                            @(((string)egitmen.AdSoyad)?.Substring(0, 1).ToUpper())
                                        </div>
                                        <span>@egitmen.AdSoyad</span>
                                        <span class="badge bg-info ms-auto">Eğitmen</span>
                                    </a>
                                </li>
                            }
                        }
                        else
                        {
                            <li><span class="dropdown-item text-muted">Aktif eğitmen bulunamadı</span></li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container pb-5">
    <div class="card-fc">
        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var k in Model)
                    {
                        <a asp-action="Chat" asp-route-userId="@k.KarsiTarafId" 
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 @(k.OkunmamisSayisi > 0 ? "bg-light" : "")">
                            <div class="d-flex align-items-center gap-3">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                    @k.KarsiTarafAdi?.Substring(0, 1).ToUpper()
                                </div>
                                <div>
                                    <strong>@k.KarsiTarafAdi</strong>
                                    @if (k.KonusmaTipi == "TrainerAdmin")
                                    {
                                        <span class="badge bg-info ms-1">Eğitmen</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary ms-1">Üye</span>
                                    }
                                    <div class="text-muted small text-truncate" style="max-width: 300px;">
                                        @(k.SonMesaj?.Length > 50 ? k.SonMesaj.Substring(0, 50) + "..." : k.SonMesaj)
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">@k.SonMesajTarihi?.ToString("dd MMM, HH:mm")</small>
                                @if (k.OkunmamisSayisi > 0)
                                {
                                    <span class="badge bg-danger rounded-pill">@k.OkunmamisSayisi</span>
                                }
                            </div>
                        </a>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5 text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mb-3 opacity-50">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <h5>Henüz Mesajınız Yok</h5>
                    <p class="mb-3">Bir eğitmen seçerek yeni sohbet başlatabilirsiniz.</p>
                    @if (egitmenler.Any())
                    {
                        <!-- Yeni Sohbet Butonu (Boş durumda) -->
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Yeni Sohbet Başlat
                            </button>
                            <ul class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
                                <li><h6 class="dropdown-header">Eğitmen Seçin</h6></li>
                                @foreach (var egitmen in egitmenler)
                                {
                                    <li>
                                        <a class="dropdown-item" asp-action="Chat" asp-route-userId="@egitmen.ApplicationUserId">
                                            @egitmen.AdSoyad
                                        </a>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>
