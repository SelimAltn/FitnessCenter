@model FitnessCenter.Web.Models.ViewModels.AiResultVm
@{
    ViewData["Title"] = "AI √ñneri Sonucu";
    var isPolling = ViewBag.IsPolling == true;
    var requestId = ViewBag.RequestId as string ?? "";
}

<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" 
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                         class="me-2" style="color: var(--fc-success);">
                        <polyline points="9 11 12 14 22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    Ki≈üisel Fitness √ñneriniz
                </h1>
                <p class="text-muted mb-0" id="inputSummaryText">@Model.InputSummary</p>
            </div>
            <div id="badgesContainer">
                @if (Model.IsCached)
                {
                    <span class="badge-fc badge-fc-info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" 
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        √ñnbellekten
                    </span>
                }
                @if (!string.IsNullOrEmpty(Model.RecommendationType))
                {
                    <span class="badge-fc badge-fc-primary ms-1">
                        @Model.RecommendationType
                    </span>
                }
            </div>
        </div>
    </div>
</div>

<div class="container pb-5">
    @* ===== LOADING STATE (Polling Mode) ===== *@
    @if (isPolling)
    {
        <div id="loadingContainer" class="text-center py-5">
            <div class="ai-loading-spinner mb-4">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3 id="loadingTitle" style="color: var(--fc-gray-700);">AI Yanƒ±tƒ±nƒ±z Hazƒ±rlanƒ±yor</h3>
            <p id="loadingMessage" class="text-muted">Ki≈üiselle≈ütirilmi≈ü √∂neriniz olu≈üturuluyor, l√ºtfen bekleyin...</p>
            <div class="progress mt-4" style="max-width: 400px; margin: 0 auto; height: 6px;">
                <div id="loadingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                     style="width: 10%; background-color: var(--fc-primary);"></div>
            </div>
        </div>
    }

    @* ===== RESULT CONTAINER (Hidden initially in polling mode) ===== *@
    <div id="resultContainer" style="@(isPolling ? "display:none;" : "")">
        
        @* ===== ALAKASIZ FOTOƒûRAF UYARISI ===== *@
        <div id="irrelevantImageAlert" class="@(Model.IsImageRelevant ? "d-none" : "")" style="margin-bottom: 2rem;">
            <div class="card-fc" style="border-left: 4px solid var(--fc-danger); background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
                <div class="card-body">
                    <div class="d-flex align-items-start gap-4">
                        <div class="flex-shrink-0">
                            <div class="p-3 rounded-circle" style="background-color: #fecaca;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" 
                                     stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                                    <circle cx="9" cy="9" r="2"/>
                                    <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                                    <line x1="4" y1="4" x2="20" y2="20" stroke="#dc2626" stroke-width="2"/>
                                </svg>
                            </div>
                        </div>
                        <div>
                            <h4 style="color: #b91c1c; margin-bottom: 0.75rem;">üì∑ Fotoƒüraf V√ºcut Analizi ƒ∞√ßin Uygun Deƒüil</h4>
                            <p style="color: #7f1d1d; font-size: 1.1rem; margin-bottom: 0.5rem;">
                                <strong>G√∂rselde g√∂r√ºlenler:</strong> 
                                <span id="imageDescription">@Model.ImageDescription</span>
                            </p>
                            <p style="color: #991b1b; margin-bottom: 1rem;">
                                <strong>Nedeni:</strong> 
                                <span id="imageAnalysisReason">@Model.ImageAnalysisReason</span>
                            </p>
                            <div class="alert-fc alert-fc-info" style="margin-top: 1rem; padding: 1rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" 
                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4"/>
                                    <path d="M12 8h.01"/>
                                </svg>
                                <span>
                                    <strong>√ñnerimiz:</strong> L√ºtfen net bir v√ºcut fotoƒürafƒ± y√ºkleyin veya 
                                    <strong>Boy/Kilo/Ya≈ü</strong> bilgilerinizi girerek tekrar deneyin.
                                </span>
                            </div>
                            <div class="mt-4">
                                <a asp-action="Recommend" class="btn-fc btn-fc-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" 
                                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                        <path d="M3 3v5h5"/>
                                    </svg>
                                    Tekrar Dene
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* ===== NORMAL RESULT CONTENT (only show if image is relevant or not photo-only) ===== *@
        <div id="normalResultContent" class="@(!Model.IsImageRelevant ? "d-none" : "")">
            
            @* AI/Fallback Durum Bildirimi *@
            <div id="statusAlert" class="result-section" style="opacity: 0; transform: translateY(20px);">
                @if (Model.IsFallback)
                {
                    <div class="alert-fc alert-fc-warning mb-4" style="border-left: 4px solid #f59e0b; background-color: #fffbeb;">
                        <div class="d-flex align-items-center gap-3">
                            <div class="flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" 
                                     stroke="#b45309" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                    <line x1="12" y1="9" x2="12" y2="13"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                            </div>
                            <div>
                                <strong style="color: #b45309; font-size: 1.1rem;">‚ö†Ô∏è AI Eri≈üilemedi - Sistem Otomatik √ñneri (Fallback)</strong>
                                <p class="mb-0 mt-1" style="color: #92400e;">
                                    AI servisi ≈üu an kullanƒ±lamƒ±yor. A≈üaƒüƒ±daki √∂neriler sistem tarafƒ±ndan otomatik olarak olu≈üturuldu.
                                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                                    {
                                        <br/><small>Detay: @Model.ErrorMessage</small>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                }
                else if (Model.IsSuccess)
                {
                    <div class="alert-fc alert-fc-success mb-4" style="border-left: 4px solid #10b981; background-color: #ecfdf5;">
                        <div class="d-flex align-items-center gap-3">
                            <div class="flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" 
                                     stroke="#059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                            </div>
                            <div>
                                <strong style="color: #059669; font-size: 1.1rem;">‚úÖ √ñneri AI Tarafƒ±ndan √úretildi</strong>
                                <p class="mb-0 mt-1" style="color: #047857;">
                                    Bu √∂neri <span id="modelUsedText">@(Model.ModelUsed ?? "Gemini AI")</span> modeli tarafƒ±ndan ki≈üiselle≈ütirilmi≈ü olarak olu≈üturuldu.
                                    @if (!string.IsNullOrEmpty(Model.RecommendationType))
                                    {
                                        <span class="ms-2 badge" style="background-color: #d1fae5; color: #065f46;">@Model.RecommendationType</span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @* √ñzet Kartƒ± *@
            <div id="summaryCard" class="row mb-4 result-section" style="opacity: 0; transform: translateY(20px);">
                <div class="col-12">
                    <div class="card-fc" style="background: linear-gradient(135deg, var(--fc-primary) 0%, var(--fc-primary-dark) 100%); color: white;">
                        <div class="card-body">
                            <div class="d-flex align-items-start gap-3">
                                <div class="p-3 rounded-circle" style="background-color: rgba(255,255,255,0.15);">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" 
                                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 8V4H8"/>
                                        <rect width="16" height="12" x="4" y="8" rx="2"/>
                                        <path d="M2 14h2"/>
                                        <path d="M20 14h2"/>
                                        <path d="M15 13v2"/>
                                        <path d="M9 13v2"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="mb-2" style="color: white;">√ñzet</h4>
                                    <p id="summaryText" class="mb-0" style="opacity: 0.95; font-size: 1.1rem; line-height: 1.6;">
                                        @Model.Summary
                                    </p>
                                </div>
                            </div>
                            <div class="mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.2);">
                                <small id="generatedAtText" style="opacity: 0.7;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" 
                                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                    Olu≈üturulma: @Model.GeneratedAt.ToLocalTime().ToString("dd MMMM yyyy, HH:mm")
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                @* Antrenman Planƒ± *@
                <div class="col-lg-6">
                    <div id="workoutCard" class="card-fc h-100 result-section" style="opacity: 0; transform: translateY(20px);">
                        <div class="card-header d-flex align-items-center gap-2">
                            <span class="p-2 rounded" style="background-color: var(--fc-success-light); color: var(--fc-success);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" 
                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M6.5 6.5a2.5 2.5 0 0 1 5 0v11a2.5 2.5 0 0 1-5 0v-11z"/>
                                    <path d="M17.5 6.5a2.5 2.5 0 0 0-5 0v11a2.5 2.5 0 0 0 5 0v-11z"/>
                                    <path d="M4 12h4"/>
                                    <path d="M16 12h4"/>
                                </svg>
                            </span>
                            Antrenman Planƒ±
                        </div>
                        <div class="card-body">
                            <ul id="workoutList" class="list-unstyled mb-0">
                                @if (Model.WorkoutPlan != null && Model.WorkoutPlan.Any())
                                {
                                    @foreach (var item in Model.WorkoutPlan)
                                    {
                                        <li class="d-flex align-items-start gap-3 mb-3 workout-item">
                                            <span class="flex-shrink-0 d-flex align-items-center justify-content-center rounded-circle" 
                                                  style="width: 24px; height: 24px; background-color: var(--fc-success-light); color: var(--fc-success);">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" 
                                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="20 6 9 17 4 12"/>
                                                </svg>
                                            </span>
                                            <span style="color: var(--fc-gray-700);">@item</span>
                                        </li>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted mb-0">Antrenman planƒ± bilgisi bulunamadƒ±.</p>
                                }
                            </ul>
                        </div>
                    </div>
                </div>

                @* Beslenme √ñnerileri *@
                <div class="col-lg-6">
                    <div id="nutritionCard" class="card-fc h-100 result-section" style="opacity: 0; transform: translateY(20px);">
                        <div class="card-header d-flex align-items-center gap-2">
                            <span class="p-2 rounded" style="background-color: var(--fc-info-light); color: var(--fc-info);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" 
                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M2.27 21.7s9.87-3.5 12.73-6.36a4.5 4.5 0 0 0-6.36-6.37C5.77 11.84 2.27 21.7 2.27 21.7zM8.64 14l-2.05-2.04M15.34 15l5.27-5.27"/>
                                    <path d="M21 2l-4.47 4.47"/>
                                    <path d="M21.25 9.25l-2.5 2.5"/>
                                    <path d="M14.5 4.5l-3.5 3.5"/>
                                </svg>
                            </span>
                            Beslenme √ñnerileri
                        </div>
                        <div class="card-body">
                            <ul id="nutritionList" class="list-unstyled mb-0">
                                @if (Model.NutritionTips != null && Model.NutritionTips.Any())
                                {
                                    @foreach (var item in Model.NutritionTips)
                                    {
                                        <li class="d-flex align-items-start gap-3 mb-3 nutrition-item">
                                            <span class="flex-shrink-0 d-flex align-items-center justify-content-center rounded-circle" 
                                                  style="width: 24px; height: 24px; background-color: var(--fc-info-light); color: var(--fc-info);">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" 
                                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="20 6 9 17 4 12"/>
                                                </svg>
                                            </span>
                                            <span style="color: var(--fc-gray-700);">@item</span>
                                        </li>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted mb-0">Beslenme √∂nerisi bilgisi bulunamadƒ±.</p>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            @* Uyarƒ±lar *@
            <div id="warningsCard" class="row mt-4 result-section" style="opacity: 0; transform: translateY(20px); @(Model.Warnings == null || !Model.Warnings.Any() ? "display:none;" : "")">
                <div class="col-12">
                    <div class="card-fc" style="border-left: 4px solid var(--fc-warning);">
                        <div class="card-header d-flex align-items-center gap-2">
                            <span class="p-2 rounded" style="background-color: var(--fc-warning-light); color: #b45309;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" 
                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                    <line x1="12" y1="9" x2="12" y2="13"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                            </span>
                            Dikkat Edilmesi Gerekenler
                        </div>
                        <div class="card-body">
                            <ul id="warningsList" class="list-unstyled mb-0">
                                @if (Model.Warnings != null && Model.Warnings.Any())
                                {
                                    @foreach (var item in Model.Warnings)
                                    {
                                        <li class="d-flex align-items-start gap-3 mb-3 warning-item">
                                            <span class="flex-shrink-0 d-flex align-items-center justify-content-center rounded-circle" 
                                                  style="width: 24px; height: 24px; background-color: var(--fc-warning-light); color: #b45309;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" 
                                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <line x1="12" y1="16" x2="12" y2="12"/>
                                                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                                                </svg>
                                            </span>
                                            <span style="color: var(--fc-gray-700);">@item</span>
                                        </li>
                                    }
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Aksiyon Butonlarƒ± *@
        <div id="actionButtons" class="d-flex justify-content-center gap-3 mt-5 result-section" style="opacity: 0; transform: translateY(20px);">
            <a asp-action="Recommend" class="btn-fc btn-fc-primary btn-fc-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" 
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                    <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                    <path d="M16 21h5v-5"/>
                </svg>
                Yeni √ñneri Al
            </a>
            <a asp-controller="Home" asp-action="Index" class="btn-fc btn-fc-secondary btn-fc-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" 
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                Ana Sayfa
            </a>
        </div>

        @* Bilgilendirme *@
        <div id="infoFooter" class="text-center mt-5 result-section" style="opacity: 0;">
            <small style="color: var(--fc-gray-500);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" 
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4"/>
                    <path d="M12 8h.01"/>
                </svg>
                Bu √∂neriler genel bilgi ama√ßlƒ±dƒ±r. Herhangi bir saƒülƒ±k programƒ±na ba≈ülamadan √∂nce doktorunuza danƒ±≈üƒ±n.
            </small>
        </div>
    </div>

    @* ===== ERROR STATE ===== *@
    <div id="errorContainer" class="d-none text-center py-5">
        <div class="mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" 
                 stroke="#dc2626" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        </div>
        <h3 style="color: #dc2626;">Bir Hata Olu≈ütu</h3>
        <p id="errorMessage" class="text-muted mb-4">ƒ∞≈ülem sƒ±rasƒ±nda beklenmeyen bir hata olu≈ütu.</p>
        <a asp-action="Recommend" class="btn-fc btn-fc-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" 
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
            Tekrar Dene
        </a>
    </div>
</div>

@section Scripts {
    <style>
        /* Loading Spinner */
        .ai-loading-spinner {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: var(--fc-primary);
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        .spinner-ring:nth-child(1) { animation-delay: -0.45s; }
        .spinner-ring:nth-child(2) { animation-delay: -0.3s; border-top-color: var(--fc-primary-light); }
        .spinner-ring:nth-child(3) { animation-delay: -0.15s; border-top-color: rgba(79, 70, 229, 0.3); }

        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Fade-in animation for result sections */
        .result-section {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .result-section.visible {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* List item animations */
        .workout-item, .nutrition-item, .warning-item {
            opacity: 0;
            transform: translateX(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .workout-item.visible, .nutrition-item.visible, .warning-item.visible {
            opacity: 1;
            transform: translateX(0);
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isPolling = @(isPolling ? "true" : "false");
            const requestId = "@requestId";

            if (isPolling && requestId) {
                startPolling(requestId);
            } else {
                // Normal mode - animate sections
                animateResultSections();
            }
        });

        let pollCount = 0;
        const maxPolls = 60; // 60 saniye timeout

        function startPolling(requestId) {
            const loadingProgress = document.getElementById('loadingProgress');
            const loadingMessage = document.getElementById('loadingMessage');

            const pollInterval = setInterval(async function() {
                pollCount++;

                // Progress bar g√ºncelle
                const progress = Math.min(10 + (pollCount * 3), 90);
                loadingProgress.style.width = progress + '%';

                // Mesaj g√ºncelle
                if (pollCount > 5) {
                    loadingMessage.textContent = 'AI modeli yanƒ±t olu≈üturuyor...';
                }
                if (pollCount > 15) {
                    loadingMessage.textContent = 'Ki≈üiselle≈ütirilmi≈ü √∂nerileriniz hazƒ±rlanƒ±yor...';
                }

                // Timeout kontrol√º
                if (pollCount >= maxPolls) {
                    clearInterval(pollInterval);
                    showError('ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.');
                    return;
                }

                try {
                    const response = await fetch('/Ai/Status?requestId=' + requestId);
                    const responseText = await response.text();
                    
                    // DEBUG: Response'u logla
                    console.log('Poll #' + pollCount + ' - Raw response:', responseText.substring(0, 200));
                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        return;
                    }
                    
                    // DEBUG: Parsed data'yƒ± logla
                    console.log('Poll #' + pollCount + ' - Parsed data:', {
                        status: data.status,
                        hasResult: data.result != null,
                        resultType: typeof data.result,
                        errorMessage: data.errorMessage
                    });

                    if (data.status === 'Completed') {
                        console.log('Status is Completed! Stopping polling and displaying result...');
                        clearInterval(pollInterval);
                        loadingProgress.style.width = '100%';
                        
                        setTimeout(() => {
                            displayResult(data.result);
                        }, 300);
                    } else if (data.status === 'Error') {
                        console.log('Status is Error:', data.errorMessage);
                        clearInterval(pollInterval);
                        showError(data.errorMessage || 'Bir hata olu≈ütu.');
                    } else {
                        console.log('Status is still:', data.status, '- continuing poll...');
                    }
                    // Processing durumunda devam et
                } catch (error) {
                    console.error('Polling fetch error:', error);
                    // Aƒü hatasƒ± durumunda hemen durma, bir daha dene
                }
            }, 1000); // 1 saniye aralƒ±kla
        }

        function displayResult(result) {
            try {
                console.log('displayResult called with:', JSON.stringify(result, null, 2));
                
                const loadingContainer = document.getElementById('loadingContainer');
                const resultContainer = document.getElementById('resultContainer');

                // Null/undefined result kontrol√º
                if (!result) {
                    console.error('Result is null or undefined!');
                    showError('Sonu√ß alƒ±namadƒ±. L√ºtfen tekrar deneyin.');
                    return;
                }

                console.log('Result properties:', {
                    summary: result.summary,
                    workoutPlanLength: result.workoutPlan?.length,
                    nutritionTipsLength: result.nutritionTips?.length,
                    isImageRelevant: result.isImageRelevant
                });

                // Loading'i gizle
                loadingContainer.style.display = 'none';

            // Fotoƒüraf uygun deƒüilse
            if (result.isImageRelevant === false) {
                document.getElementById('irrelevantImageAlert').classList.remove('d-none');
                document.getElementById('normalResultContent').classList.add('d-none');
                document.getElementById('imageDescription').textContent = result.imageDescription || 'Bilinmeyen i√ßerik';
                document.getElementById('imageAnalysisReason').textContent = result.imageAnalysisReason || 'V√ºcut analizi i√ßin uygun deƒüil.';
            } else {
                document.getElementById('irrelevantImageAlert').classList.add('d-none');
                document.getElementById('normalResultContent').classList.remove('d-none');

                // Sonu√ßlarƒ± DOM'a yaz (null check ile)
                const summaryTextEl = document.getElementById('summaryText');
                if (summaryTextEl) summaryTextEl.textContent = result.summary || '';
                
                const inputSummaryTextEl = document.getElementById('inputSummaryText');
                if (inputSummaryTextEl) inputSummaryTextEl.textContent = result.inputSummary || '';
                
                const modelUsedTextEl = document.getElementById('modelUsedText');
                if (modelUsedTextEl && result.modelUsed) {
                    modelUsedTextEl.textContent = result.modelUsed;
                }

                // Antrenman planƒ±
                const workoutList = document.getElementById('workoutList');
                if (workoutList) {
                    workoutList.innerHTML = '';
                    if (result.workoutPlan && result.workoutPlan.length > 0) {
                        result.workoutPlan.forEach(item => {
                            workoutList.innerHTML += createListItem(item, 'workout-item', 'var(--fc-success-light)', 'var(--fc-success)');
                        });
                    } else {
                        workoutList.innerHTML = '<p class="text-muted mb-0">Antrenman planƒ± bilgisi bulunamadƒ±.</p>';
                    }
                }

                // Beslenme √∂nerileri
                const nutritionList = document.getElementById('nutritionList');
                if (nutritionList) {
                    nutritionList.innerHTML = '';
                    if (result.nutritionTips && result.nutritionTips.length > 0) {
                        result.nutritionTips.forEach(item => {
                            nutritionList.innerHTML += createListItem(item, 'nutrition-item', 'var(--fc-info-light)', 'var(--fc-info)');
                        });
                    } else {
                        nutritionList.innerHTML = '<p class="text-muted mb-0">Beslenme √∂nerisi bilgisi bulunamadƒ±.</p>';
                    }
                }

                // Uyarƒ±lar
                const warningsCard = document.getElementById('warningsCard');
                const warningsList = document.getElementById('warningsList');
                if (warningsCard && warningsList) {
                    warningsList.innerHTML = '';
                    if (result.warnings && result.warnings.length > 0) {
                        warningsCard.style.display = '';
                        result.warnings.forEach(item => {
                            warningsList.innerHTML += createWarningItem(item);
                        });
                    } else {
                        warningsCard.style.display = 'none';
                    }
                }
            }

            // Sonu√ß container'ƒ± g√∂ster
            resultContainer.style.display = '';

            // Animasyonlarƒ± ba≈ülat
            setTimeout(() => animateResultSections(), 100);
            
            console.log('displayResult completed successfully!');
            } catch (error) {
                console.error('displayResult error:', error);
                showError('Sonu√ß g√∂sterilirken hata olu≈ütu: ' + error.message);
            }
        }

        function createListItem(text, className, bgColor, color) {
            return `
                <li class="d-flex align-items-start gap-3 mb-3 ${className}">
                    <span class="flex-shrink-0 d-flex align-items-center justify-content-center rounded-circle" 
                          style="width: 24px; height: 24px; background-color: ${bgColor}; color: ${color};">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" 
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </span>
                    <span style="color: var(--fc-gray-700);">${text}</span>
                </li>
            `;
        }

        function createWarningItem(text) {
            return `
                <li class="d-flex align-items-start gap-3 mb-3 warning-item">
                    <span class="flex-shrink-0 d-flex align-items-center justify-content-center rounded-circle" 
                          style="width: 24px; height: 24px; background-color: var(--fc-warning-light); color: #b45309;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" 
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                    </span>
                    <span style="color: var(--fc-gray-700);">${text}</span>
                </li>
            `;
        }

        function animateResultSections() {
            const sections = document.querySelectorAll('.result-section');
            let delay = 0;

            sections.forEach((section, index) => {
                setTimeout(() => {
                    section.classList.add('visible');

                    // List item'larƒ± da animasyonla g√∂ster
                    const items = section.querySelectorAll('.workout-item, .nutrition-item, .warning-item');
                    items.forEach((item, itemIndex) => {
                        setTimeout(() => {
                            item.classList.add('visible');
                        }, itemIndex * 100);
                    });
                }, delay);
                delay += 200; // Her b√∂l√ºm 200ms arayla
            });
        }

        function showError(message) {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('errorContainer').classList.remove('d-none');
            document.getElementById('errorMessage').textContent = message;
        }
    </script>
}
