@model FitnessCenter.Web.Models.ViewModels.AiResultVm

@{
    ViewData["Title"] = "AI Öneri Detayı";
    var aiLog = ViewBag.AiLog as FitnessCenter.Web.Models.Entities.AiLog;
    var isPhotoMode = ViewBag.IsPhotoMode ?? false;
}

@functions {
    string GetCategoryClass(string? category)
    {
        return category switch
        {
            "Zayıf" => "text-info",
            "Normal" => "text-success",
            "Kilolu" or "Şişman" => "text-warning",
            "Obez" => "text-danger",
            "Kaslı" => "text-primary",
            _ => "text-secondary"
        };
    }
}

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div>
                <h1>AI Öneri Detayı</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/">Ana Sayfa</a></li>
                        <li class="breadcrumb-item"><a asp-controller="Ai" asp-action="History">Önceki Önerilerim</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Detay</li>
                    </ol>
                </nav>
            </div>
            <div class="d-flex gap-2">
                <a asp-controller="Ai" asp-action="History" class="btn-fc btn-fc-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    Geri Dön
                </a>
                <a asp-controller="Ai" asp-action="Recommend" class="btn-fc btn-fc-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                    Yeni Öneri Al
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container pb-5">
    <!-- Meta Info -->
    @if (aiLog != null)
    {
        <div class="card-fc mb-4">
            <div class="card-body">
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <span class="badge-fc @(isPhotoMode ? "badge-fc-info" : "badge-fc-primary")">
                        @(isPhotoMode ? "Photo Modu" : "Data Modu")
                    </span>
                    @if (Model.IsSuccess)
                    {
                        <span class="badge-fc badge-fc-success">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            Başarılı
                        </span>
                    }
                    else
                    {
                        <span class="badge-fc badge-fc-danger">Başarısız</span>
                    }
                    @if (aiLog.DurationMs.HasValue)
                    {
                        <span class="text-muted-fc" style="font-size: 0.875rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            @(aiLog.DurationMs / 1000.0)s
                        </span>
                    }
                    <span class="ms-auto text-muted-fc" style="font-size: 0.875rem;">
                        @aiLog.OlusturulmaZamani.ToLocalTime().ToString("dd MMM yyyy HH:mm")
                    </span>
                </div>
            </div>
        </div>
    }

    @if (Model.IsSuccess)
    {
        <!-- Özet Kartı -->
        <div class="card-fc mb-4" style="border-left: 4px solid var(--fc-primary);">
            <div class="card-header d-flex align-items-center gap-2" style="background: linear-gradient(135deg, var(--fc-primary), var(--fc-primary-dark, #1a8754)); color: white;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                Analiz Özeti
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    @if (Model.BMI.HasValue)
                    {
                        <div class="col-4">
                            <div class="fs-2 fw-bold" style="color: var(--fc-primary);">@Model.BMI.Value.ToString("F1")</div>
                            <small class="text-muted-fc">BMI</small>
                        </div>
                    }
                    <div class="col-4">
                        <div class="fs-4 fw-bold @GetCategoryClass(Model.BodyCategory)">@(Model.BodyCategory ?? "—")</div>
                        <small class="text-muted-fc">Kategori</small>
                    </div>
                    <div class="col-4">
                        <div class="fs-5" style="color: var(--fc-info);">@(Model.IsCached ? "Cache" : "Yeni")</div>
                        <small class="text-muted-fc">Kaynak</small>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(Model.Summary))
                {
                    <p class="lead mb-0">@Model.Summary</p>
                }
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.RawText))
        {
            <div class="alert-fc alert-fc-info mb-4">
                <pre class="mb-0" style="white-space: pre-wrap;">@Model.RawText</pre>
            </div>
        }
        else
        {
            <!-- Antrenman Planı ve Beslenme Önerileri -->
            <div class="row g-4 mb-4">
                @if (Model.WorkoutPlan?.Count > 0)
                {
                    <div class="col-md-6">
                        <div class="card-fc h-100">
                            <div class="card-header d-flex align-items-center gap-2" style="background: var(--fc-success); color: white;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                Haftalık Antrenman Planı
                            </div>
                            <ul class="list-group list-group-flush">
                                @foreach (var item in Model.WorkoutPlan)
                                {
                                    <li class="list-group-item d-flex align-items-start gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0 mt-1" style="color: var(--fc-success);">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        @item
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                }

                @if (Model.NutritionTips?.Count > 0)
                {
                    <div class="col-md-6">
                        <div class="card-fc h-100">
                            <div class="card-header d-flex align-items-center gap-2" style="background: var(--fc-info); color: white;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                                    <line x1="6" y1="1" x2="6" y2="4"></line>
                                    <line x1="10" y1="1" x2="10" y2="4"></line>
                                    <line x1="14" y1="1" x2="14" y2="4"></line>
                                </svg>
                                Beslenme Önerileri
                            </div>
                            <ul class="list-group list-group-flush">
                                @foreach (var item in Model.NutritionTips)
                                {
                                    <li class="list-group-item d-flex align-items-start gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0 mt-1" style="color: var(--fc-danger);">
                                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                        </svg>
                                        @item
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                }
            </div>

            <!-- Uyarılar -->
            @if (Model.Notes?.Count > 0)
            {
                <div class="card-fc mb-4" style="border-color: var(--fc-warning);">
                    <div class="card-header d-flex align-items-center gap-2" style="background: var(--fc-warning); color: #000;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        Dikkat Edilmesi Gerekenler
                    </div>
                    <ul class="list-group list-group-flush">
                        @foreach (var item in Model.Notes)
                        {
                            <li class="list-group-item list-group-item-warning d-flex align-items-start gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0 mt-1">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                @item
                            </li>
                        }
                    </ul>
                </div>
            }

            <!-- AI Üretilen Görsel (Photo Mode) -->
            @if (isPhotoMode && !string.IsNullOrEmpty(Model.AfterGeneratedImageUrl))
            {
                <div class="card-fc mb-4" style="border-color: var(--fc-success);">
                    <div class="card-header d-flex align-items-center gap-2" style="background: var(--fc-success); color: white;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        AI Tahmini Görünüm
                    </div>
                    <div class="card-body text-center">
                        <img src="@Model.AfterGeneratedImageUrl" alt="AI Tahmini Görünüm" 
                             class="img-fluid rounded shadow" 
                             style="max-height: 400px; object-fit: contain;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none;" class="alert-fc alert-fc-warning mb-0">
                            Görsel yüklenemedi
                        </div>
                        <div class="alert-fc alert-fc-info mt-3 mb-0 py-2">
                            <small>
                                Bu görsel AI tarafından üretilmiştir. Gerçek sonuçlar kişiden kişiye değişir.
                            </small>
                        </div>
                    </div>
                </div>
            }

            <!-- Before/After Görselleri (Data Mode) -->
            @if (!isPhotoMode && !string.IsNullOrEmpty(Model.BeforeImagePath) && !string.IsNullOrEmpty(Model.AfterImagePath))
            {
                <div class="card-fc mb-4">
                    <div class="card-header d-flex align-items-center gap-2" style="background: var(--fc-secondary); color: white;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        Tahmini Görünüm (Temsili)
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 text-center">
                                <div class="border rounded p-3 bg-light-fc" style="min-height: 200px;">
                                    <img src="@Model.BeforeImagePath" alt="Mevcut Durum" 
                                         class="img-fluid rounded" 
                                         style="max-height: 160px; object-fit: contain;">
                                </div>
                                <p class="mt-2 mb-0 fw-bold text-muted-fc">Mevcut</p>
                            </div>
                            <div class="col-6 text-center">
                                <div class="border rounded p-3 bg-light-fc" style="min-height: 200px; border-color: var(--fc-success) !important; border-width: 2px !important;">
                                    <img src="@Model.AfterImagePath" alt="Hedef Görünüm" 
                                         class="img-fluid rounded" 
                                         style="max-height: 160px; object-fit: contain;">
                                </div>
                                <p class="mt-2 mb-0 fw-bold" style="color: var(--fc-success);">Plan Sonrası</p>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.TransformationCaption))
                        {
                            <div class="alert-fc alert-fc-info mt-3 mb-0 py-2">
                                <small>@Model.TransformationCaption</small>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    }
    else
    {
        <!-- Hata Durumu -->
        <div class="alert-fc alert-fc-danger">
            <div class="d-flex align-items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                <div>
                    <strong>İşlem Başarısız</strong>
                    <p class="mb-0 mt-1">@(Model.ErrorMessage ?? "Bilinmeyen bir hata oluştu.")</p>
                </div>
            </div>
        </div>
    }
</div>
