@* Views/Shared/_LoginPartial.cshtml - YouTube/Instagram Tarzı Bildirim Sistemi *@
@using Microsoft.AspNetCore.Identity
@using FitnessCenter.Web.Data.Context
@inject SignInManager<FitnessCenter.Web.Models.Entities.ApplicationUser> SignInManager
@inject UserManager<FitnessCenter.Web.Models.Entities.ApplicationUser> UserManager
@inject AppDbContext DbContext

<ul class="navbar-nav ms-auto align-items-center">
    @if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);
        var userId = user?.Id ?? "";
        var userEmail = user?.Email ?? "";
        var userName = user?.UserName ?? User.Identity?.Name ?? "Kullanıcı";
        var initials = userName.Length >= 2 ? userName.Substring(0, 2).ToUpper() : userName.ToUpper();
        
        // Okunmamış bildirim sayısı ve son bildirimler
        var okunmamisSayisi = DbContext.Bildirimler.Count(b => b.UserId == userId && !b.Okundu);
        var sonBildirimler = DbContext.Bildirimler
            .Where(b => b.UserId == userId)
            .OrderByDescending(b => b.OlusturulmaTarihi)
            .Take(5)
            .ToList();

        <!-- 🔔 Bildirim Çanı -->
        <li class="nav-item dropdown me-2">
            <a class="nav-link notification-bell" 
               href="#" 
               role="button" 
               data-bs-toggle="dropdown" 
               aria-expanded="false"
               title="Bildirimler">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                    <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                </svg>
                @if (okunmamisSayisi > 0)
                {
                    <span class="notification-badge">@(okunmamisSayisi > 9 ? "9+" : okunmamisSayisi.ToString())</span>
                }
            </a>
            <div class="dropdown-menu dropdown-menu-end notification-dropdown">
                <!-- Header -->
                <div class="notification-dropdown-header">
                    <strong>Bildirimler</strong>
                    @if (okunmamisSayisi > 0)
                    {
                        <form asp-controller="Bildirim" asp-action="TumunuOku" method="post" class="d-inline">
                            <button type="submit" class="btn-link-sm">Tümünü okundu işaretle</button>
                        </form>
                    }
                </div>
                
                <!-- Bildirim Listesi -->
                <div class="notification-list">
                    @if (sonBildirimler.Any())
                    {
                        @foreach (var bildirim in sonBildirimler)
                        {
                            var icon = bildirim.Tur switch
                            {
                                "DestekYaniti" => "💬",
                                "YeniUyelik" => "🎉",
                                "YeniRandevu" => "📅",
                                "YeniDestekTalebi" => "📩",
                                _ => "🔔"
                            };
                            
                            <a asp-controller="Bildirim" asp-action="Oku" asp-route-id="@bildirim.Id" 
                               class="notification-item @(!bildirim.Okundu ? "unread" : "")">
                                <span class="notification-icon">@icon</span>
                                <div class="notification-content">
                                    <div class="notification-title">@bildirim.Baslik</div>
                                    <div class="notification-text">@(bildirim.Mesaj.Length > 60 ? bildirim.Mesaj.Substring(0, 60) + "..." : bildirim.Mesaj)</div>
                                    <div class="notification-time">@bildirim.OlusturulmaTarihi.ToString("dd.MM.yy HH:mm")</div>
                                </div>
                            </a>
                        }
                    }
                    else
                    {
                        <div class="notification-empty">
                            <span>🔔</span>
                            <p>Bildirim yok</p>
                        </div>
                    }
                </div>
                
                <!-- Footer -->
                <div class="notification-dropdown-footer">
                    <a asp-controller="Bildirim" asp-action="Index">Tüm bildirimleri gör</a>
                </div>
            </div>
        </li>

        <!-- 👤 Profil Dropdown -->
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center gap-2 profile-dropdown-toggle" 
               href="#" 
               role="button" 
               data-bs-toggle="dropdown" 
               aria-expanded="false">
                <span class="profile-avatar">
                    @initials
                </span>
                <span class="d-none d-md-inline">@userName</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end profile-dropdown-menu">
                <!-- Kullanıcı Bilgisi -->
                <li class="dropdown-header profile-dropdown-header">
                    <div class="profile-dropdown-avatar">@initials</div>
                    <div class="profile-dropdown-info">
                        <strong>@userName</strong>
                        <small>@userEmail</small>
                    </div>
                </li>
                <li><hr class="dropdown-divider"></li>
                
                @if (User.IsInRole("Admin"))
                {
                    <!-- Admin Menü Öğeleri -->
                    <li>
                        <a class="dropdown-item" asp-area="Admin" asp-controller="Randevu" asp-action="Index" asp-route-durum="Beklemede">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            Bekleyen Randevular
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" asp-area="Admin" asp-controller="Kullanici" asp-action="Index">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Kullanıcılar
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" asp-area="Admin" asp-controller="Destek" asp-action="Index">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            Destek Talepleri
                        </a>
                    </li>
                }
                else
                {
                    <!-- Normal Kullanıcı Menü Öğeleri -->
                    <li>
                        <a class="dropdown-item" asp-area="" asp-controller="Account" asp-action="Settings">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            Ayarlar
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" asp-area="" asp-controller="Account" asp-action="Profile">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            Profil Düzenle
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" asp-area="" asp-controller="Help" asp-action="Index">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <path d="M12 17h.01"/>
                            </svg>
                            Yardım
                        </a>
                    </li>
                }
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form asp-area="" asp-controller="Account" asp-action="Logout" method="post" class="d-inline w-100">
                        <button type="submit" class="dropdown-item text-danger">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            Çıkış Yap
                        </button>
                    </form>
                </li>
            </ul>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link" asp-controller="Account" asp-action="Register">
                Kayıt Ol
            </a>
        </li>
        <li class="nav-item">
            <a class="btn-logout" asp-controller="Account" asp-action="Login">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                    <polyline points="10 17 15 12 10 7"/>
                    <line x1="15" y1="12" x2="3" y2="12"/>
                </svg>
                Giriş Yap
            </a>
        </li>
    }
</ul>
